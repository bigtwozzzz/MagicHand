# 《奥术之手：亡灵天灾》技术选型文档

## 1. 项目概述

本项目是一款基于手势识别的魔法打僵尸游戏，支持单人模式和双人合作模式。游戏采用即时战斗、波次挑战、肉鸽成长等核心玩法，需要实现稳定的手势识别、流畅的游戏体验和可靠的网络同步。

## 2. 技术架构总览

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   手势识别模块    │    │    游戏引擎      │    │   网络通信模块   │
│ Python+MediaPipe│◄──►│     Unity       │◄──►│ Protobuf+TCP   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │   本地通信模块   │
                       │      UDP        │
                       └─────────────────┘
```

## 3. 核心技术选型

### 3.1 游戏引擎：Unity

#### 选择理由
- **跨平台支持**：Unity支持Windows、Mac、移动端等多平台发布
- **丰富的资源**：庞大的Asset Store生态系统，丰富的第三方插件
- **可视化开发**：直观的场景编辑器，便于快速原型开发
- **性能优化**：成熟的渲染管线和性能分析工具
- **网络支持**：内置Netcode for GameObjects，便于多人游戏开发
- **学习成本**：团队成员熟悉C#和Unity开发环境

#### 技术优势
- 强大的3D渲染能力，支持华丽的魔法特效
- 完善的物理引擎，适合实时战斗游戏
- 灵活的组件系统，便于模块化开发
- 丰富的动画系统，支持复杂的角色和特效动画

#### 版本选择
- **Unity 2022.3 LTS**：长期支持版本，稳定性好

### 3.2 手势识别：Python + MediaPipe

#### 选择理由
- **高精度识别**：MediaPipe是Google开源的机器学习框架，手势识别精度高
- **实时性能**：优化的推理引擎，支持实时手势检测
- **易于集成**：Python生态丰富，便于快速开发和调试
- **跨平台**：支持多种操作系统和硬件平台
- **开源免费**：无授权费用，适合学习项目

#### 技术特性
- **手部关键点检测**：21个手部关键点，精确识别手势形状
- **多手检测**：支持双手同时识别，适合双人合作模式
- **手势分类**：可自定义手势类别，支持复杂魔法手势
- **实时处理**：60FPS的处理能力，满足游戏实时性要求

#### 实现方案
```python
# 核心技术栈
MediaPipe Hands    # 手部检测和关键点提取
OpenCV            # 图像处理和摄像头接口
NumPy             # 数值计算和特征处理
Socket            # 与Unity通信
```

### 3.3 本地通信：UDP协议

#### 选择理由
- **低延迟**：无连接协议，减少握手开销
- **高性能**：适合高频率的手势数据传输
- **简单可靠**：本地通信环境稳定，丢包率低
- **实时性**：满足游戏对实时性的严格要求

#### 应用场景
- Python手势识别模块 ↔ Unity游戏引擎
- 传输内容：手势识别结果、手部坐标、置信度等
- 传输频率：30-60Hz

#### 数据格式
```json
{
  "timestamp": 1234567890,
  "hands": [
    {
      "hand_id": 0,
      "gesture": "fireball",
      "confidence": 0.95,
      "landmarks": [...]
    }
  ]
}
```

### 3.4 网络通信：Protobuf + TCP

#### 选择理由
- **数据压缩**：Protobuf二进制序列化，数据量小
- **跨语言**：支持多种编程语言，便于扩展
- **版本兼容**：向前向后兼容，便于协议升级
- **可靠传输**：TCP保证数据完整性和顺序
- **类型安全**：强类型定义，减少通信错误

#### 应用场景
- 客户端之间的游戏状态同步
- 玩家动作、魔法释放、伤害计算等
- 房间管理、匹配系统等

#### 协议设计
```protobuf
syntax = "proto3";

message GameState {
  int64 timestamp = 1;
  repeated Player players = 2;
  repeated Enemy enemies = 3;
  repeated MagicEffect effects = 4;
}

message Player {
  string player_id = 1;
  Vector3 position = 2;
  int32 health = 3;
  int32 mana = 4;
  repeated Spell spells = 5;
}

message MagicAction {
  string player_id = 1;
  string spell_name = 2;
  Vector3 target_position = 3;
  int64 cast_time = 4;
}
```

## 4. 技术架构详细设计

### 4.1 系统模块划分

#### 手势识别模块 (Python)
```
GestureRecognition/
├── camera_manager.py      # 摄像头管理
├── hand_detector.py       # 手部检测
├── gesture_classifier.py  # 手势分类
├── data_sender.py         # 数据发送
└── config.py             # 配置管理
```

#### 游戏核心模块 (Unity C#)
```
GameCore/
├── GestureReceiver.cs     # 手势数据接收
├── MagicSystem.cs         # 魔法系统
├── CombatManager.cs       # 战斗管理
├── NetworkManager.cs      # 网络管理
└── GameStateManager.cs    # 游戏状态管理
```

### 4.2 数据流设计

```
摄像头 → MediaPipe → 手势识别 → UDP → Unity → 魔法释放
                                    ↓
                              TCP/Protobuf
                                    ↓
                               网络同步
```

### 4.3 性能优化策略

#### 手势识别优化
- **帧率控制**：动态调整处理帧率，平衡性能和精度
- **ROI优化**：感兴趣区域检测，减少计算量
- **多线程处理**：异步处理手势识别和数据传输

#### 网络优化
- **状态压缩**：只同步变化的游戏状态
- **预测补偿**：客户端预测和服务端校正
- **批量传输**：合并小数据包，减少网络开销

## 5. 开发环境和工具链

### 5.1 开发环境
- **操作系统**：Windows 10/11
- **Unity版本**：Unity 2022.3 LTS
- **Python版本**：Python 3.8+
- **IDE**：Visual Studio 2022 + PyCharm

### 5.2 依赖库版本
```
# Python依赖
mediapipe==0.10.7
opencv-python==4.8.1
numpy==1.24.3
protobuf==4.24.4

# Unity包
com.unity.netcode.gameobjects@1.5.2
com.unity.multiplayer.tools@1.4.0
```

### 5.3 构建工具
- **版本控制**：Git + GitHub
- **CI/CD**：GitHub Actions
- **包管理**：Unity Package Manager + pip

## 6. 风险评估和备选方案

### 6.1 技术风险

| 风险项 | 风险等级 | 影响 | 缓解措施 |
|--------|----------|------|----------|
| 手势识别精度不足 | 中 | 游戏体验差 | 增加训练数据，优化算法 |
| 网络延迟过高 | 中 | 多人体验差 | 本地预测+服务端校正 |
| Unity性能瓶颈 | 低 | 帧率下降 | 性能分析和优化 |
| 跨平台兼容性 | 低 | 部署困难 | 充分测试，渐进式发布 |

### 6.2 备选技术方案

#### 手势识别备选
- **OpenPose**：更全面的姿态检测，但性能要求高
- **TensorFlow Lite**：移动端优化，但需要自训练模型
- **Azure Kinect**：硬件方案，精度高但成本高

#### 网络通信备选
- **Mirror Networking**：Unity专用网络框架
- **Photon**：商业网络解决方案
- **WebRTC**：P2P通信，适合小规模对战

## 7. 开发计划和里程碑

### 7.1 技术验证阶段 (2周)
- [ ] MediaPipe手势识别原型
- [ ] Unity基础场景搭建
- [ ] UDP通信测试
- [ ] 基础魔法效果实现

### 7.2 核心功能开发 (4周)
- [ ] 完整手势识别系统
- [ ] 游戏核心玩法实现
- [ ] 单人模式完成
- [ ] 网络框架搭建

### 7.3 多人功能开发 (3周)
- [ ] 双人合作模式
- [ ] 组合技能系统
- [ ] 网络同步优化
- [ ] 性能调优

### 7.4 测试和优化 (2周)
- [ ] 功能测试
- [ ] 性能测试
- [ ] 用户体验测试
- [ ] Bug修复和优化

## 8. 总结

本技术选型方案充分考虑了项目需求、团队技术栈、开发周期和成本等因素。通过Unity + Python + MediaPipe的组合，能够实现高质量的手势识别魔法游戏，同时保证开发效率和系统稳定性。

选型的核心优势：
- **技术成熟**：所选技术都有丰富的社区支持和文档
- **开发效率**：团队熟悉的技术栈，学习成本低
- **扩展性好**：模块化设计，便于后续功能扩展
- **性能可控**：经过验证的技术方案，性能可预期

通过合理的架构设计和技术选型，项目能够在预定时间内完成开发目标，为用户提供优秀的游戏体验。